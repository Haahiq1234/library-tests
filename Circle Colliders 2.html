<html>
<head>
</head>
<body>
    <script>
        var FramesPerSecond = 80;
        var balls = [];
        var lines = [];
        class Line {
            constructor(x1, y1, x2, y2) {
                this.a = new Vector2(x1, y1);
                this.b = new Vector2(x2, y2);
            }
            show() {
                stroke(0);
                line(this.a.x, this.a.y, this.b.x, this.b.y);
            }
        }
        var ln;
        let res = 100;
        function setUp() {
            createCanvas(400, 400, "white");
            frameRate(FramesPerSecond);
            for (var i = 0; i < 1; i++) {
                balls.push(new Ball(Random.range(CanvasWidth), Random.range(CanvasHeight), 20, color(255, 0, 0)));
            }
            console.log(balls);
            gravity = new Vector2(0, 0.1);
            ln = new Line(100, 100, 200, 200);
            for (var i = 0; i < 5; i++) {
                let x = Random.rangeInt(CanvasWidth / res) * res;
                let y = Random.rangeInt(CanvasHeight / res) * res;
                let x1 = Random.rangeInt(CanvasWidth / res) * res;
                let y1 = Random.rangeInt(CanvasHeight / res) * res;
                if (x != x1 || y != y1) {
                    lines.push(new Line(x, y, x1, y1));
                }
            }
        }
        function draw() {
            clear();
            for (l of lines) {
                l.show();
            }
            ln.show();
            for (var i = 0; i < balls.length; i++) {
                balls[i].run();
            }
        }
        class Ball {
            constructor(x, y, r, col, acc) {
                this.pos = new Vector2(x, y);
                this.vel = new Vector2(0, 0);
                this.acc = new Vector2(0, 0);
                this.r = r;
                this.m = r ** 2;
                this.color = col;
                this.maxSpeed = 4;
                this.maxAcc = 0.1;
            }
            edges() {
                this.pos.x = constraint(this.pos.x, this.r, CanvasWidth - this.r);
                this.pos.y = constraint(this.pos.y, this.r, CanvasHeight - this.r);
            }
            addForce(force) {
                force = force.copy().div(this.m);
                this.acc.add(force);
            }
            collide() {
                for (var ln of lines) {
                    let coll = checkCircleLineCollision(ln.a.x, ln.a.y, ln.b.x, ln.b.y, this.pos.x, this.pos.y, this.r);
                    if (coll.collided) {
                        this.pos = coll.position;
                    }
                }
            }
            update() {
                //this.acc.add(Vector.sub(this.pos, mousePos).mult(-1));
                //this.acc.add(gravity);
                //this.acc.limit(this.maxAcc);
                this.pos = mouse.copy();
                this.vel.add(this.acc);
                this.vel.limit(this.maxSpeed);
                this.pos.add(this.vel);
                this.acc.reset();
            }
            run(i) {
                this.update();
                this.collide();
                this.edges();
                this.draw(i);
            }
            draw(i) {
                fill(this.color);
                circle(this.pos.x, this.pos.y, this.r);
            }
        }
        function checkCircleLineCollision(p1x, p1y, p2x, p2y, cx, cy, cr) {
            let a = mag(p1x - cx, p1y - cy);
            let b = mag(p2x - cx, p2y - cy);
            let c = mag(p1x - p2x, p1y - p2y);
            let area = geometry.herosFormula(a, b, c);
            let height = (2 * area) / c;
            let xPos = false;
            if (p1x < p2x) {
                xPos = true;
            }
            let yPos = false;;
            if (p1y < p2y) {
                yPos = true;
            }
            if (height < cr && (((xPos && cx > p1x && cx < p2x) || (!xPos && cx < p1x && cx > p2x)) || ((yPos && cy > p1y && cy < p2y) || (!yPos && cy < p1y && cy > p2y)))) {
                console.log(height);
                let len = geometry.perpendicular(a, height);
                let pt = Vector.dir(p1x, p1y, p2x, p2y).mult(len);
                pt.add(new Vector2(p1x, p1y));
                let nPos = new Vector2(cx, cy).sub(pt).setMag(cr);
                return {
                    collided: true,
                    point: pt,
                    position: pt.copy().add(nPos)
                };
            }
            if (a < cr) {
                let pt = new Vector2(p1x, p1y);
                let nPos = new Vector2(cx, cy).sub(pt).setMag(cr);
                return {
                    collided: true,
                    point: pt,
                    position: pt.copy().add(nPos)
                };
            }
            if (b < cr) {
                let pt = new Vector2(p2x, p2y);
                let nPos = new Vector2(cx, cy).sub(pt).setMag(cr);
                return {
                    collided: true,
                    point: pt,
                    position: pt.copy().add(nPos)
                };
            }
            return {
                collided: false
            };
        }
    </script>
    <script src="Canvas.js"></script>
</body>
</html>
