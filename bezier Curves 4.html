
<html>
<head>
    <link rel="stylesheet" href="style.css"/>
</head>
<body>
    <script src="Canvas.js"></script>
    <script>
        var curve;
        Gizmo.DEFAULTRADIUS = 8.5;
        function setUp() {
            //console.log("ok");
            createCanvas();
            //frameRate(30);
            curve = new Spline(100, 300, 100, 100, 300, 300, 300, 100);
            //curve.add(500, 100, 500, 300);
            //curve.add(500, 100, 500, 300);
            //curve.add(500, 100, 500, 300);
        }
        function draw() {
            clear();
            curve.draw();
        }
        function bound() {
            console.log(this);
        }
        let slider = new Slider(50, 300, 50, 100, 0, 100, 50);
        function bCurve(a, b, pa, pb, ena, enb) {
            let lp = a;
            lineWidth(3);
            stroke(150, 100);
            if (ena) {
                ln(pa, a);
            }
            if (enb) {
                ln(pb, b);
            }
            let val = slider.value;
            saveLineState();
            stroke(0);
            lineWidth(2);
            //console.log(val);
            for (var t = 0; t <= 1; t += 1 / val) {
                let c = Vector.lerp(a, pa, t);
                let d = Vector.lerp(pa, pb, t);
                let e = Vector.lerp(pb, b, t);

                let f = Vector.lerp(c, d, t);
                let g = Vector.lerp(d, e, t);

                let h = Vector.lerp(f, g, t);

                ln(lp, h);
                lp = h;
            }
            ln(lp, b);
            loadLineState();
        }
        function SelectGizmo(gizmo) {            
            for (var child of currentSelectedGizmo.children) {
                child.enabled = false;
            }

            for (var child of gizmo.children) {
                child.enabled = true;
            }
            currentSelectedGizmo = gizmo;
        }
        let currentSelectedGizmo;
        class Spline {
            constructor(ax, ay, pax, pay, bx, by, pbx, pby) {
                this.spline = [new Curve(bx, by, pbx, pby, false, ax, ay, pax, pay)];
                currentSelectedGizmo = this.spline[0].a;
                this.spline[0].pa.enabled = true;
            }
            add(bx, by, bcx, bcy) {
                this.spline.push(new Curve(bx, by, bcx, bcy, this.spline[this.spline.length - 1]));
            }
            draw() {
                for (var curve of this.spline) {
                    curve.draw();
                }
            }
        }
        class Curve {
            constructor(bx, by, bcx, bcy, previous, px, py, pbx, pby) { // ac = a control, bc = b control, previuos = previous curve piece, b = position of point

                this.b = new Gizmo(bx, by);
                this.pb = new Gizmo(bcx, bcy);
                this.pb.setParent(this.b);
                let x;
                let y;
                if (previous) {
                    this.a = previous.b;
                    x = 2 * previous.b.x - previous.pb.x;
                    y = 2 * previous.b.y - previous.pb.y;
                    this.pa = new Gizmo(x, y);
                    this.pa.pair(previous.pb, "move", (dt, a, b) => {
                        let pp = b.parentPosition;
                        let p = a.position;
                        b.position = new Vector2(pp.x * 2 - p.x, pp.y * 2 - p.y);
                    });
                } else {
                    this.a = new Gizmo(px, py);
                    this.pa = new Gizmo(pbx, pby);
                }
                this.pa.setParent(this.a);

                this.a.bind("click", SelectGizmo);
                this.b.bind("click", SelectGizmo);

                this.pa.enabled = false;
                this.pb.enabled = false;
            }
       
            Update() {
                this.av = this.a.position;
                this.bv = this.pa.position;
                this.cv = this.pb.position;
                this.dv = this.b.position;
            }
            p(t) {
                let P1 = this.av.copy().mult(-(t ** 3) + 3 * (t ** 2) - 3 * t + 1);
                let P2 = this.bv.copy().mult(3 * (t ** 3) - 6 * (t ** 2) + 3 * t);
                let P3 = this.cv.copy().mult(-3 * (t ** 3) + 3 * (t ** 2));
                let P4 = this.dv.copy().mult(t ** 3);
                return Vector.add(P1, P2, P3, P4);
            }
            draw() {
                this.Update();
                let lp = this.av;
                lineWidth(3);
                stroke(150, 100);
                if (this.pa.enabled) {
                    ln(this.av,this.bv);
                }
                if (this.pb.enabled) {
                    ln(this.cv, this.dv);
                }
                let val = slider.value;
                saveLineState();
                stroke(0);
                lineWidth(2);
                //console.log(val);
                for (var t = 0; t <= 1; t += 1 / val) {
                    let h = this.p(t);
                    ln(lp, h);
                    lp = h;
                }
                ln(lp, this.dv);
                loadLineState();
            }
        }
        function ln(A, B) {
            line(A.x, A.y, B.x, B.y);
        }
        function pt(P) {
            circle(P.x, P.y, 5);
        }
    </script>

</body>
</html>
