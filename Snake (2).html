<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <script src="Canvas.js"></script>
    <script>
        let res = 40;
        let w;
        let h;
        var food = [];
        let grid;
        function setUp() {
            createCanvas(400, 400);
            frameRate(60);
            w = CanvasWidth / res;
            h = CanvasHeight / res;
            new Snake(0, 0);
            grid = new Grid();
            //new Snake(res - 1, res - 1, color(0, 0, 255));
        }
        function draw() {
            clear();
            grid.recalculate();
            grid.render();
            Snake.update();
        }
        function key_Press() {
            // if (GetKeyAction("right")) {
            //     snake.vel.set(1, 0);
            // }
            // if (GetKeyAction("up")) {
            //     snake.vel.set(0, -1);
            // }
            // if (GetKeyAction("left")) {
            //     snake.vel.set(-1, 0);
            // }
            // if (GetKeyAction("down")) {
            //     snake.vel.set(0, 1);
            // }
        }
        class Grid extends Array2D {
            constructor() {
                super(res, res);
                this.array.fill(0);
            }
            render() {
                for (var x = 0; x < this.width; x++) {
                    for (var y = 0; y < this.height; y++) {
                        let val = this.get(x, y);
                        if (val == 1) {
                            fill(255, 0, 0);
                            rect(x * w, y * h, w, h);
                        }
                    }
                }
            }
            neighbours(p) {
                let ns = [];
                if (p.x > 0 ) {
                    let val = this.get(p.x - 1, p.y);
                    if (val == 0) {
                        ns.push(new Vector2(p.x - 1, p.y));
                    }
                }
                if (p.y > 0 ) {
                    let val = this.get(p.x, p.y - 1);
                    if (val == 0) {
                        ns.push(new Vector2(p.x, p.y - 1));
                    }
                }
                if (p.x < (this.width - 1)) {
                    let val = this.get(p.x + 1, p.y);
                    if (val == 0) {
                        ns.push(new Vector2(p.x + 1, p.y));
                    }
                }
                if (p.y < (this.height - 1)) {
                    let val = this.get(p.x, p.y + 1);
                    if (val == 0) {
                        ns.push(new Vector2(p.x, p.y + 1));
                    }
                }
            }
            recalculate() {
                this.array.fill(0);
                for (var snake of Snake.snakes) {
                    for (var p of snake.saved) {
                        this.set(p.x, p.y, 1);
                    }
                }
            }
        }
        class Snake {
            static snakes = [];
            static update() {
                for (var snake of Snake.snakes) {
                    snake.update();
                }
            }
            constructor(x, y, ac = color(255, 255, 0), bc = color(255, 0, 0)) {
                Snake.snakes.push(this);
                this.pos = new Vector2(x, y);
                this.vel = new Vector2(0, 0);
                this.saved = [];
                this.last = this.pos.copy();
                this.segments = 1;
                this.ac = ac;
                this.bc = bc;
                this.calculateTarget();
            }
            calculateTarget() {
                this.target = new Vector2(Random.rangeInt(0, res), Random.rangeInt(0, res));
            }
            follow(p) {
                let dir = Vector.sub(p, this.pos);
                if (dir.x == 0 && dir.y == 0) {
                    this.calculateTarget();
                    this.segments++;
                } else {
                    let lv = this.vel;
                    let path = [];
                    for (var i = 0; i < 5; i++) {
                        let vel = new Vector2(0, 0);
                        if (abs(dir.y) >= abs(dir.x)) {
                            vel = new Vector2(0, Math.sign(dir.y));
                        }
                        if (abs(dir.x) >= abs(dir.y)) {
                            vel = new Vector2(Math.sign(dir.x), 0);
                        }
                        let ns = [];
                    }
                }
                //console.log(dir);
            }
            rotate3() {
                if (this.vel.x == 1 && this.vel.y == 0) {
                    this.vel.x = 0;
                    this.vel.y = 1;
                } else if (this.vel.x == 0 && this.vel.y == 1) {
                    this.vel.x = -1;
                    this.vel.y = 0;
                } else if (this.vel.x == -1 && this.vel.y == 0) {
                    this.vel.x = 0;
                    this.vel.y = -1;
                } else if (this.vel.x == 0 && this.vel.y == -1) {
                    this.vel.x = 1;
                    this.vel.y = 0;
                }
            }
            rotate1() {
                this.vel = this.vel.neg();
            }
            rotate() {
                if (this.vel.x == 1 && this.vel.y == 0) {
                    this.vel.x = 0;
                    this.vel.y = -1;
                } else if (this.vel.x == 0 && this.vel.y == 1) {
                    this.vel.x = 1;
                    this.vel.y = 0;
                } else if (this.vel.x == -1 && this.vel.y == 0) {
                    this.vel.x = 0;
                    this.vel.y = 1;
                } else if (this.vel.x == 0 && this.vel.y == -1) {
                    this.vel.x = -1;
                    this.vel.y = 0;
                }
            }
            collided(pts) {
                //return false;
                for (var i = 0; i < pts.length; i++) {
                    if (Vector.Equal(pts[i], Vector.add(this.pos, this.vel))) {
                        return true;
                    }
                }
                let coll = false;
                    let cx = constraint(this.x, 0, res - 1);
                if (cx != this.x) {
                    coll = true;
                }
                this.x = cx;
                let cy = constraint(this.y, 0, res - 1)
                if (cy != this.y) {
                    coll = true;
                }
                this.y = cy;

                return coll;
            }
            update() {
                this.follow(this.target);
                if (frameNo % 6 == 0) {

                    if (this.collided(this.saved)) {
                        //endGame();
                    }
                    this.saved.push(this.pos.copy());
                    this.last = this.saved[0].copy();
                    if (this.saved.length > this.segments) {
                        //console.log("done");
                        this.saved.shift();
                    }
                    this.pos.add(this.vel);
                }
                fill(0, 255, 0);
                rect(this.target.x * w, this.target.y * h, w, h);


                //this.render();
            }
            get x() {
                return this.pos.x;
            }
            get y() {
                return this.pos.y;
            }
            set x(x) {
                this.pos.x = x;
            }
            set y(y) {
                this.pos.y = y;
            }
            render() {
                fill(255, 0, 0);
                for (var i = 0; i < this.saved.length; i++) {
                    let p = this.saved[i];
                    let t = i / (this.saved.length - 1);
                    fill(Colors.interpolate(this.ac, this.bc, t));
                    rect(p.x * w, p.y * w, w, h);
                }
            }
        }
        function endGame() {
            alert("gameOver");
            noLoop();
            return;
        }
    </script>
</body>

</html>