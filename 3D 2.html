<html>
<head>
    <link rel="stylesheet" href="style.css"/>
</head>
<body>
    <script src="Canvas.js"></script>
    <script>
        Camera.position.z = -2;
        var points = [
            new Vector3(-0.5, -0.5, 0.5),
            new Vector3(0.5, -0.5, 0.5),
            new Vector3(0.5, 0.5, 0.5),
            new Vector3(-0.5, 0.5, 0.5),
            new Vector3(-0.5, -0.5, -0.5),
            new Vector3(0.5, -0.5, -0.5),
            new Vector3(0.5, 0.5, -0.5),
            new Vector3(-0.5, 0.5, -0.5)
        ]
        let slider;
        let ang = 0;
        let speed = 0.1;
        function setUp() {
            createCanvas(400, 400);
            frameRate(60);
            //noLoop();
            Camera.setSpeed(speed, speed, speed)
            Canvas.setOrigin();
            setAxis("rot", "g", "h");
            slider = createSlider(-360, 360, 0.1, 0, "Y Rotation");
        }
        function draw() {
            clear();
            //Camera.resetWorldRotation();
            Camera.rotationy += GetAxis("rot");
            let pts = [];
            fill(0);
            for (var pt of points) {
                let pt1 = pt.rotated(0, 0, 0);
                let pt2 = pt1.persp().mult(200);
                circle(pt2.x, pt2.y, 3);
                pts.push(pt2);
            }
            projected = pts;
            for (var i = 0; i < 4; i++) {
                connect(0, i, (i + 1) % 4);
                connect(0, i, i + 4);
                connect(0, i + 4, 4 + (i + 1) % 4);
            }
            //clear();
            let vertices = [
                new Vector3(0.5, 0.5, 0.5),  // 0 1
                new Vector3(-0.5, 0.5, 0.5), // 3 2
                new Vector3(-0.5, -0.5, 0.5),
                new Vector3(0.5, -0.5, 0.5),

                new Vector3(0.5, 0.5, -0.5), //  4 5
                new Vector3(-0.5, 0.5, -0.5), // 7 6
                new Vector3(-0.5, -0.5, -0.5),
                new Vector3(0.5, -0.5, -0.5),

                new Vector3(-0.5, -0.5, 0.5),
                new Vector3(.5, -0.5, 0.5),
                new Vector3(.5, -0.5, -0.5),
                new Vector3(-.5, -0.5, -0.5),

                new Vector3(-0.5, 0.5, 0.5),
                new Vector3(.5, 0.5, 0.5),
                new Vector3(.5, 0.5, -0.5),
                new Vector3(-.5, 0.5, -0.5),

                new Vector3(-.5, -.5, .5),
                new Vector3(-.5, -.5, -.5),
                new Vector3(-.5, .5, -.5),
                new Vector3(-.5, .5, .5),

                new Vector3(.5, -.5, .5),
                new Vector3(.5, -.5, -.5),
                new Vector3(.5, .5, -.5),
                new Vector3(.5, .5, .5)
            ];
            let indices = [
                0, 1, 2, 3, // f * 3 + 0 ,1 , 2
                //0, 2, 3,  // f * 3 + 0, 2, 3

                4, 5, 6, 7,
                //4, 6, 7,

                8, 9, 10, 11,
                //8, 10, 11,

                12, 13, 14, 15,
                //12, 14, 15,

                16, 17, 18, 19,
                //16, 18, 19

                20, 21, 22, 23
                //20, 22, 23
            ];
            let cols = [
                //255, 0, 0,
                255, 0, 0,

                //0, 255, 0,
                0, 255, 0,

                //255, 255, 0,
                255, 255, 0,

                //0, 0, 255,
                0, 0, 255,

                //0, 255, 255,
                0, 255, 255,

                //255, 0, 255,
                255, 0, 255
            ];
            drawMesh(vertices, indices, cols, 4);
            ang += 1;
            rotateY(1);
        }
        function drawMesh(verts, indis, cols, vertsPerFace = 3) {
            let faces = [];
            for (var i = 0; i < indis.length; i += vertsPerFace) {
                let face = [];
                for (var j = 0; j < vertsPerFace; j++) {
                    face.push(verts[indis[(i + j)]]);
                    //console.log(i + j);
                }
                faces.push(face);
            }
            //console.log(faces);
            let sorted = [];
            let sortedIndices = [];
            for (var i = 0; i < faces.length; i++) {
                let projected = [];
                for (var j = 0; j < faces[i].length; j++) {
                    //console.log(i * 3 + j, faces[i].length);
                    projected[j] = faces[i][j].persp();
                }
                let avg = Vector3D.avg(...projected);
                let ind = sorted.length;
                for (var j = sorted.length - 1; j >= 0 ; j--) {
                    if (sorted[j].mag() > avg.mag()) {
                        ind = j;
                    }
                }
                sorted.splice(ind, 0, avg);
                sortedIndices.splice(ind, 0, i);
            }
            for (var i = sorted.length - 1; i >= 0; i--) {
                let face = faces[sortedIndices[i]];
                let projected = [];
                for (var j = 0; j < face.length; j++) {
                    projected[j] = face[j].persp().mult(200);
                }
                noStroke();
                let col = [];
                for (var j = sortedIndices[i] * 3; j < (sortedIndices[i] + 1) * 3; j++) {
                    col.push(cols[j]);
                }
                fill(...col);
                let vs = Vector.array(...projected);
                shape.draw(...vs);
            }
            //console.log(sortedIndices);
            //console.log(sorted);
        }
        function connect(off, a, b) {
            let av = projected[a];
            let bv = projected[b];
            line(av.x, av.y, bv.x, bv.y);
        }
    </script>

</body>
</html>
